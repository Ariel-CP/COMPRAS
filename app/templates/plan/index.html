{% extends 'base.html' %}
{% block title %}Plan de Producción{% endblock %}
{% block content %}
<h2>Plan de Producción Mensual</h2>
{% if error %}
<div class="error">Error: {{ error }}</div>
{% endif %}
<form id="filtros">
  <label>Año <input type="number" id="anio" min="2000" max="2100" value="{{ anio }}" /></label>
  <label>Mes <input type="number" id="mes" min="1" max="12" value="{{ mes }}" /></label>
  <button type="button" id="btnCargar">Cargar</button>
  <button type="button" id="btnGuardar">Guardar</button>
  <button type="button" id="btnLimpiar">Limpiar período</button>
</form>

<table id="tablaPlan">
  <thead>
    <tr>
      <th>Producto</th>
      <th>Cantidad planificada</th>
    </tr>
  </thead>
  <tbody>
    {% for item in plan %}
    <tr>
      <td>{{ item.producto_codigo }}</td>
      <td><input type="number" step="0.000001" value="{{ item.cantidad_planificada }}" data-codigo="{{ item.producto_codigo }}" /></td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<p class="hint">Para agregar productos nuevos, ingréselos manualmente al guardar: se enviarán junto con el resto.</p>
{% endblock %}
{% block scripts %}
<script>
(async function(){
  const anioEl = document.getElementById('anio');
  const mesEl = document.getElementById('mes');
  const btnCargar = document.getElementById('btnCargar');
  const btnGuardar = document.getElementById('btnGuardar');
  const btnLimpiar = document.getElementById('btnLimpiar');

  btnCargar.addEventListener('click', () => {
    const a = anioEl.value || new Date().getFullYear();
    const m = mesEl.value || (new Date().getMonth()+1);
    window.location.search = `?anio=${a}&mes=${m}`;
  });

  btnGuardar.addEventListener('click', async () => {
    const a = anioEl.value; const m = mesEl.value;
    const rows = Array.from(document.querySelectorAll('#tablaPlan tbody tr'));
    const items = rows.map(r => {
      const inp = r.querySelector('input');
      return { producto_codigo: inp.dataset.codigo || r.cells[0].textContent.trim(), cantidad: Number(inp.value||0) };
    }).filter(x => x.producto_codigo);

    const resp = await fetch(`/api/plan/${a}/${m}?sobrescribir=false`, {
      method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ items })
    });
    const data = await resp.json();
    alert(`Insertados: ${data.insertados}, Actualizados: ${data.actualizados}, Rechazados: ${data.rechazados}`);
  });

  btnLimpiar.addEventListener('click', async () => {
    const a = anioEl.value; const m = mesEl.value;
    if(!confirm('¿Seguro que desea borrar el período?')) return;
    const resp = await fetch(`/api/plan/${a}/${m}?confirmar=true`, { method: 'DELETE' });
    if(resp.ok){ alert('Período borrado'); location.reload(); } else { alert('Error al borrar'); }
  });
})();
</script>
{% endblock %}
